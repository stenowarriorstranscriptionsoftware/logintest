<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <title>Steno Warriors Transcription Software</title>
  <!-- Add Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="lookup.js"></script>
  <script src="textLookup.js"></script>
  <script src="1c2.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <!-- Add login container at the top -->
  <div id="login-container" class="login-container">
    <div class="login-content">
      <h2>Welcome to Steno Warriors</h2>
      <p>Please sign in with Google to access the transcription tests</p>
      <button id="googleSignIn" class="google-signin-btn">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google logo">
        Sign in with Google
      </button>
    </div>
  </div>

  <div class="header">
    <h1>Steno Warriors Transcription Software</h1>
    <div id="user-info" style="display: none;">
      <img id="user-photo" width="40" height="40" style="border-radius: 50%; vertical-align: middle;">
      <span id="user-name" style="margin: 0 10px;"></span>
      <button id="signOut" class="sign-out-btn">Sign Out</button>
    </div>
  </div>

  <div class="main" id="app-content" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>Please select a Test</h2>
      <button id="showLeaderboard" class="download-btn">Show Leaderboard</button>
    </div>
    
    <div class="select-panel">
      <select id="volume-select">
        <option value="1">Test 1-50 (General Matter)</option>
        <option value="2">Test 51-100 (KC Mix Transcription)</option>
      </select>

      <select id="test-select">
      </select>
    
      <select id="speed-select">
        <option value="80">80 WPM</option>
        <option value="100">100 WPM</option>
      </select>
    </div>
    <div id="video-container"></div>

    <div class="timer-container">
      Typing timer: <span id="timer">50:00</span>
      <div class="timer-controls">
        <label><input type="radio" name="duration" value="2400"> 40 min</label>
        <label><input type="radio" name="duration" value="3000" checked> 50 min</label>
        <button id="startPause" class="tmrBtn">Start</button>
        <button id="reset" class="tmrBtn">Reset</button>
      </div>
    </div>
    
    <div id="paragraphA"></div>
    <textarea class="inputBox" id="paragraphB" spellcheck="false" placeholder="Click Start to begin typing" disabled></textarea>
    <div class="resultText" id="textBoxC" style="display: none;"></div>
    <button onclick="downloadPDF()" class="download-btn">Show Result</button>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboard-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Leaderboard</h2>
      <div class="leaderboard-filters">
        <select id="leaderboard-test-select">
          <option value="all">All Tests</option>
        </select>
        <select id="leaderboard-speed-select">
          <option value="all">All Speeds</option>
          <option value="80">80 WPM</option>
          <option value="100">100 WPM</option>
        </select>
        <button id="refresh-leaderboard" class="download-btn">Refresh</button>
      </div>
      <div id="leaderboard-content">
        <table id="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Test</th>
              <th>Speed</th>
              <th>Accuracy</th>
              <th>Words</th>
              <th>Typed</th>
              <th>Time</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="leaderboard-pagination">
        <button id="prev-page" disabled>Previous</button>
        <span id="page-info">Page 1 of 1</span>
        <button id="next-page" disabled>Next</button>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>
      Made with <span style="color: red;">&hearts;</span> &middot; Anish &middot; <a href=""> Contact </a>
    </div>
  </div>

  <!-- Add these scripts before your main script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Initialize Firebase with your config
   const firebaseConfig = {
  apiKey: "AIzaSyAMdvxzt9XKs2uxB5EAy-UcdjePc2Vtz6E",
  authDomain: "stenowarriors-47c9c.firebaseapp.com",
  databaseURL: "https://stenowarriors-47c9c-default-rtdb.firebaseio.com",
  projectId: "stenowarriors-47c9c",
  storageBucket: "stenowarriors-47c9c.firebasestorage.app",
  messagingSenderId: "548502848523",
  appId: "1:548502848523:web:6c7decf798b19c588cb30e",
  measurementId: "G-S2SL10HXB9"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Google Sign In function
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          // User signed in
          console.log("User signed in:", result.user);
        })
        .catch((error) => {
          console.error("Error signing in:", error);
          alert("Error signing in: " + error.message);
        });
    }

    // Sign Out function
    function signOut() {
      auth.signOut()
        .then(() => {
          console.log("User signed out");
        })
        .catch((error) => {
          console.error("Error signing out:", error);
        });
    }

    // Listen for auth state changes
    auth.onAuthStateChanged((user) => {
      const loginContainer = document.getElementById('login-container');
      const appContent = document.getElementById('app-content');
      const userInfo = document.getElementById('user-info');

      if (user) {
        // User is signed in
        loginContainer.style.display = 'none';
        appContent.style.display = 'block';
        userInfo.style.display = 'block';
        
        // Display user info
        document.getElementById('user-photo').src = user.photoURL || 'https://via.placeholder.com/40';
        document.getElementById('user-name').textContent = user.displayName || user.email;
        
        // Populate leaderboard test select
        populateLeaderboardTestSelect();
      } else {
        // User is signed out
        loginContainer.style.display = 'flex';
        appContent.style.display = 'none';
        userInfo.style.display = 'none';
      }
    });

    // Add event listeners
    document.getElementById('googleSignIn').addEventListener('click', signInWithGoogle);
    document.getElementById('signOut').addEventListener('click', signOut);

    // Leaderboard functionality
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentLeaderboardData = [];
    let currentTestFilter = 'all';
    let currentSpeedFilter = 'all';

    // Leaderboard modal elements
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const showLeaderboardBtn = document.getElementById('showLeaderboard');
    const closeModalBtn = document.querySelector('.close-modal');
    const leaderboardTestSelect = document.getElementById('leaderboard-test-select');
    const leaderboardSpeedSelect = document.getElementById('leaderboard-speed-select');
    const refreshLeaderboardBtn = document.getElementById('refresh-leaderboard');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageInfoSpan = document.getElementById('page-info');
    const leaderboardTableBody = document.querySelector('#leaderboard-table tbody');

    // Show leaderboard modal
    showLeaderboardBtn.addEventListener('click', () => {
      leaderboardModal.style.display = 'block';
      loadLeaderboard();
    });

    // Close leaderboard modal
    closeModalBtn.addEventListener('click', () => {
      leaderboardModal.style.display = 'none';
    });

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target === leaderboardModal) {
        leaderboardModal.style.display = 'none';
      }
    });

    // Filter leaderboard
    leaderboardTestSelect.addEventListener('change', (e) => {
      currentTestFilter = e.target.value;
      currentPage = 1;
      loadLeaderboard();
    });

    leaderboardSpeedSelect.addEventListener('change', (e) => {
      currentSpeedFilter = e.target.value;
      currentPage = 1;
      loadLeaderboard();
    });

    refreshLeaderboardBtn.addEventListener('click', () => {
      loadLeaderboard();
    });

    // Pagination
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLeaderboard();
      }
    });

    nextPageBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(currentLeaderboardData.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderLeaderboard();
      }
    });

    // Populate leaderboard test select
    function populateLeaderboardTestSelect() {
      const testSelect = document.getElementById('test-select');
      const leaderboardTestSelect = document.getElementById('leaderboard-test-select');
      
      // Clear existing options except "All Tests"
      while (leaderboardTestSelect.options.length > 1) {
        leaderboardTestSelect.remove(1);
      }
      
      // Add all available tests
      for (let i = 0; i < testSelect.options.length; i++) {
        const option = document.createElement('option');
        option.value = testSelect.options[i].value;
        option.text = testSelect.options[i].text;
        leaderboardTestSelect.appendChild(option);
      }
    }

    // Load leaderboard data from Firebase
    function loadLeaderboard() {
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
      
      database.ref('leaderboard').orderByChild('timestamp').startAt(threeMonthsAgo.getTime()).once('value')
        .then((snapshot) => {
          const leaderboardData = [];
          snapshot.forEach((childSnapshot) => {
            const result = childSnapshot.val();
            leaderboardData.push({
              id: childSnapshot.key,
              ...result
            });
          });
          
          // Filter data based on current filters
          currentLeaderboardData = leaderboardData.filter(item => {
            const testMatch = currentTestFilter === 'all' || item.testNumber === currentTestFilter;
            const speedMatch = currentSpeedFilter === 'all' || item.speed.toString() === currentSpeedFilter;
            return testMatch && speedMatch;
          });
          
          // Sort by accuracy (descending)
          currentLeaderboardData.sort((a, b) => b.accuracy - a.accuracy);
          
          // Render the first page
          currentPage = 1;
          renderLeaderboard();
        })
        .catch((error) => {
          console.error("Error loading leaderboard:", error);
          alert("Error loading leaderboard. Please try again.");
        });
    }

    // Render leaderboard data
    function renderLeaderboard() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedData = currentLeaderboardData.slice(startIndex, endIndex);
      
      // Clear table
      leaderboardTableBody.innerHTML = '';
      
      // Add rows
      paginatedData.forEach((item, index) => {
        const row = document.createElement('tr');
        const rank = startIndex + index + 1;
        
        // Format time taken
        const minutes = Math.floor(item.timeTaken / 60);
        const seconds = item.timeTaken % 60;
        const timeTakenStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Format date
        const date = new Date(item.timestamp);
        const dateStr = date.toLocaleDateString();
        
        row.innerHTML = `
          <td>${rank}</td>
          <td>${item.userName}</td>
          <td>Test ${item.testNumber}</td>
          <td>${item.speed} WPM</td>
          <td>${item.accuracy.toFixed(2)}%</td>
          <td>${item.totalWords}</td>
          <td>${item.typedWords}</td>
          <td>${timeTakenStr}</td>
          <td>${dateStr}</td>
        `;
        
        leaderboardTableBody.appendChild(row);
      });
      
      // Update pagination controls
      const totalPages = Math.ceil(currentLeaderboardData.length / itemsPerPage);
      pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Save result to leaderboard
    function saveToLeaderboard(resultData) {
      const user = auth.currentUser;
      if (!user) return;
      
      const result = {
        userName: user.displayName || 'Anonymous',
        userId: user.uid,
        testNumber: document.getElementById('test-select').value,
        speed: parseInt(document.getElementById('speed-select').value),
        accuracy: resultData.accuracy,
        totalWords: resultData.totalWords,
        typedWords: resultData.typedWords,
        timeTaken: resultData.timeTaken,
        timestamp: Date.now()
      };
      
      database.ref('leaderboard').push(result)
        .then(() => {
          console.log("Result saved to leaderboard");
        })
        .catch((error) => {
          console.error("Error saving to leaderboard:", error);
        });
    }

    // Timer functionality
    let timerDisplay = document.getElementById('timer');
    let startPauseButton = document.getElementById('startPause');
    let resetButton = document.getElementById('reset');
    let paragraphB = document.getElementById('paragraphB');
    let timerInterval;
    let timeLeft = 3000; // 50 minutes in seconds (50 * 60)
    let isTimerRunning = false;
    let startTimeStamp;
    let pausedTime = 0;
    let selectedDuration = 3000; // Default to 50 minutes

    // Format time as MM:SS
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
        timerDisplay.textContent = formatTime(timeLeft);
    }

    function startTimer() {
        if (!isTimerRunning) {
            isTimerRunning = true;
            startPauseButton.textContent = 'Pause';
            paragraphB.disabled = false;
            paragraphB.placeholder = "Start typing here...";
            paragraphB.focus();
            
            // Record start time (adjusted for paused time)
            startTimeStamp = Date.now() - pausedTime * 1000;
            pausedTime = 0;
            
            timerInterval = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - startTimeStamp) / 1000);
                timeLeft = Math.max(0, selectedDuration - elapsedSeconds);
                
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    startPauseButton.textContent = 'Start';
                    paragraphB.disabled = true;
                    compareParagraphs(); // Auto-submit when time runs out
                }
            }, 200); // Update more frequently for smoother countdown
        }
    }

    function pauseTimer() {
        if (isTimerRunning) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            startPauseButton.textContent = 'Start';
            paragraphB.disabled = true;
            paragraphB.placeholder = "Timer paused - click Start to continue";
            
            // Calculate how much time was spent in this session
            const elapsedSeconds = Math.floor((Date.now() - startTimeStamp) / 1000);
            pausedTime = selectedDuration - (timeLeft - elapsedSeconds);
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        startPauseButton.textContent = 'Start';
        paragraphB.disabled = true;
        paragraphB.value = '';
        paragraphB.placeholder = "Click Start to begin typing";
        
        // Reset to selected duration
        timeLeft = selectedDuration;
        pausedTime = 0;
        updateTimerDisplay();
    }

    function disableTimerControls() {
        startPauseButton.disabled = true;
        resetButton.disabled = true;
        document.querySelectorAll('input[name="duration"]').forEach(radio => {
            radio.disabled = true;
        });
    }

    function enableTimerControls() {
        startPauseButton.disabled = false;
        resetButton.disabled = false;
        document.querySelectorAll('input[name="duration"]').forEach(radio => {
            radio.disabled = false;
        });
    }

    // Event listeners
    startPauseButton.addEventListener('click', () => {
        if (isTimerRunning) {
            pauseTimer();
        } else {
            startTimer();
        }
    });

    resetButton.addEventListener('click', resetTimer);

    // Duration radio buttons
    document.querySelectorAll('input[name="duration"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (!isTimerRunning) {
                selectedDuration = parseInt(this.value);
                timeLeft = selectedDuration;
                updateTimerDisplay();
            }
        });
    });

    // Initialize timer display
    updateTimerDisplay();

    // Test selection functionality
    const volumeSelect = document.getElementById('volume-select');
    const testSelect = document.getElementById('test-select');
    const speedSelect = document.getElementById('speed-select');
    const videoContainer = document.getElementById('video-container');

    const tests = {
     1: Array.from({ length: 50 }, (_, i) => `${i + 1}`),
      2: Array.from({ length: 50 }, (_, i) => `${i + 51}`),
    };

    function populateTests(volume) {
      testSelect.innerHTML = '';
      const options = tests[volume];
      options.forEach(test => {
        const option = document.createElement('option');
        option.value = test;
        option.text = "Test " + test.toString();
        testSelect.appendChild(option);
      });
    }

    function updateVideo() {
      const spd = document.getElementById('speed-select').value;
      const tst = document.getElementById('test-select').value;

      videoUrl = urlLookup[parseInt(tst, 10)][parseInt(spd, 10)];
      paragraphA.value = textTable[parseInt(tst, 10)];
      paragraphB.placeholder = "Click Start to begin typing";
      videoContainer.innerHTML = `<iframe src="${videoUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
    }

    volumeSelect.addEventListener('change', () => {
      populateTests(volumeSelect.value);
      updateVideo();
    });

    testSelect.addEventListener('change', updateVideo);
    speedSelect.addEventListener('change', updateVideo);

    // Initialize on load
    populateTests(volumeSelect.value);
    updateVideo();

    // Enhanced PDF download function
    function downloadPDF() {
      // Stop the timer when showing results
      if (isTimerRunning) {
        pauseTimer();
      }
      
      // Disable timer controls
      disableTimerControls();
      
      compareParagraphs();
      
      // Get current date and time
      const currentDate = new Date();
      const day = currentDate.getDate();
      const monthIndex = currentDate.getMonth();
      const year = currentDate.getFullYear();
      const hours = currentDate.getHours();
      const currentMinutes = currentDate.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const formattedHours = hours % 12 || 12;
      const formattedMinutes = currentMinutes < 10 ? '0' + currentMinutes : currentMinutes;

      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      const formattedDate = `${day} ${monthNames[monthIndex]} ${year},`;
      const formattedTime = `${formattedHours}:${formattedMinutes} ${ampm}`;

      const headerContent = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h2 style="color: #4361ee;">Steno Warriors Result Sheet</h2>
          <div style="margin-top: 10px;">
            Test Date & Time: ${formattedDate} ${formattedTime}
          </div>
        </div>
      `;

      const headerText = document.createElement('div');
      headerText.innerHTML = headerContent;
      headerText.style.textAlign = 'center';

      const textBoxC = document.getElementById('textBoxC');
      textBoxC.insertBefore(headerText, textBoxC.firstChild);
      
      // Add download button
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'Download PDF';
      downloadBtn.className = 'download-btn';
      downloadBtn.onclick = function() {
        generatePDF();
        // Re-enable controls after PDF generation
        enableTimerControls();
      };
      
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Close Results';
      closeBtn.className = 'download-btn';
      closeBtn.style.marginLeft = '10px';
      closeBtn.onclick = function() {
        location.reload(); // Refreshes the page
      };
      
      textBoxC.appendChild(downloadBtn);
      textBoxC.appendChild(closeBtn);
      textBoxC.style.display = 'block';
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const element = document.getElementById('textBoxC');
      
      // Temporarily hide the buttons to avoid including them in the PDF
      const buttons = element.querySelectorAll('button');
      buttons.forEach(btn => {
        btn.style.display = 'none';
      });
      
      // Add some padding for better appearance in PDF
      const originalPadding = element.style.padding;
      element.style.padding = '20px';
      
      html2canvas(element, {
        scale: 2, // Higher quality
        logging: false,
        useCORS: true,
        allowTaint: true
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 295; // A4 height in mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // Restore the button visibility and original padding
        buttons.forEach(btn => {
          btn.style.display = 'block';
        });
        element.style.padding = originalPadding;
        
        pdf.save('StenoWarriors_Result.pdf');
      });
    }
  </script>
</body>
</html>
